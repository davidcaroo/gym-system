const axios = require('axios');

const BASE_URL = 'http://localhost:3001/api';

class PagosTestSuite {
    constructor() {
        this.sessionId = null;
        this.cookieString = '';
        this.testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };
    }

    async login() {
        try {
            console.log('üîë Iniciando sesi√≥n...');
            const response = await axios.post(`${BASE_URL}/auth/login`, {
                username: 'admin',
                password: 'admin123'
            });

            if (response.data.success) {
                // Extraer cookie de sesi√≥n
                const cookies = response.headers['set-cookie'];
                if (cookies) {
                    this.cookieString = cookies.join('; ');
                }
                console.log('‚úÖ Login exitoso');
                return true;
            }
            return false;
        } catch (error) {
            console.error('‚ùå Error en login:', error.response?.data || error.message);
            return false;
        }
    }

    async makeRequest(method, url, data = null) {
        try {
            const config = {
                method,
                url: `${BASE_URL}${url}`,
                headers: {
                    'Cookie': this.cookieString,
                    'Content-Type': 'application/json'
                }
            };

            if (data) {
                config.data = data;
            }

            return await axios(config);
        } catch (error) {
            throw error;
        }
    }

    async test(description, testFn) {
        this.testResults.total++;
        try {
            console.log(`üß™ ${description}`);
            await testFn();
            console.log(`   ‚úÖ PAS√ì`);
            this.testResults.passed++;
        } catch (error) {
            console.log(`   ‚ùå FALL√ì: ${error.message}`);
            this.testResults.failed++;
        }
    }

    async runTests() {
        console.log('üöÄ Iniciando pruebas del sistema de pagos\n');

        // Login inicial
        const loginSuccess = await this.login();
        if (!loginSuccess) {
            console.error('‚ùå No se pudo hacer login. Abortando pruebas.');
            return;
        }

        console.log('\nüìã PRUEBAS DEL SISTEMA DE PAGOS');
        console.log('================================');

        // Test 1: Obtener todos los pagos
        await this.test('Obtener lista de pagos', async () => {
            const response = await this.makeRequest('GET', '/pagos');
            if (!response.data.success) throw new Error('Respuesta no exitosa');
            if (!Array.isArray(response.data.data.pagos)) throw new Error('No se retorn√≥ array de pagos');
            console.log(`   üìä ${response.data.data.pagos.length} pagos encontrados`);
            console.log(`   üìà Total en BD: ${response.data.data.total} registros`);
        });

        // Test 2: Crear nuevo pago
        let nuevoPagoId;
        await this.test('Crear nuevo pago', async () => {
            const nuevoPago = {
                miembro_id: 1,
                monto: 180000,
                fecha_vencimiento: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                concepto: 'Membres√≠a Premium - Test',
                metodo_pago: 'tarjeta',
                notas: 'Pago de prueba automatizada'
            };

            const response = await this.makeRequest('POST', '/pagos', nuevoPago);
            if (!response.data.success) throw new Error('No se pudo crear el pago');
            nuevoPagoId = response.data.data.id;
            console.log(`   üí≥ Pago creado con ID: ${nuevoPagoId}`);
            console.log(`   üí∞ Monto: $${response.data.data.monto.toLocaleString()}`);
        });

        // Test 3: Obtener pago por ID
        await this.test('Obtener pago espec√≠fico', async () => {
            if (!nuevoPagoId) throw new Error('No hay ID de pago para buscar (Test 2 fall√≥)');
            const response = await this.makeRequest('GET', `/pagos/${nuevoPagoId}`);
            if (!response.data.success) throw new Error('No se pudo obtener el pago');
            if (response.data.data.id !== nuevoPagoId) throw new Error('ID no coincide');
            console.log(`   üéØ Pago encontrado: ${response.data.data.concepto}`);
            console.log(`   üë§ Miembro: ${response.data.data.nombre_miembro}`);
        });

        // Test 4: Filtrar pagos por miembro
        await this.test('Filtrar pagos por miembro', async () => {
            const response = await this.makeRequest('GET', '/pagos?miembro_id=1');
            if (!response.data.success) throw new Error('Error en filtro por miembro');
            console.log(`   üë§ Pagos del miembro 1: ${response.data.data.pagos.length}`);
        });

        // Test 5: Filtrar pagos por estado
        await this.test('Filtrar pagos por estado', async () => {
            const response = await this.makeRequest('GET', '/pagos?estado=pagado');
            if (!response.data.success) throw new Error('Error en filtro por estado');
            console.log(`   üíö Pagos confirmados: ${response.data.data.pagos.length}`);
        });

        // Test 6: Obtener estad√≠sticas de pagos
        await this.test('Obtener estad√≠sticas generales', async () => {
            const response = await this.makeRequest('GET', '/pagos/estadisticas');
            if (!response.data.success) throw new Error('Error al obtener estad√≠sticas');

            const stats = response.data.data;
            console.log(`   üìä Total pagos: ${stats.resumen.total_pagos}`);
            console.log(`   üí∞ Ingresos confirmados: $${stats.resumen.ingresos_confirmados.toLocaleString()}`);
            console.log(`   ‚è≥ Ingresos pendientes: $${stats.resumen.ingresos_pendientes.toLocaleString()}`);
            console.log(`   ‚ö†Ô∏è  Ingresos vencidos: $${stats.resumen.ingresos_vencidos.toLocaleString()}`);
            console.log(`   üìà Pago promedio: $${stats.resumen.pago_promedio.toLocaleString()}`);
        });

        // Test 7: Obtener pagos pr√≥ximos a vencer
        await this.test('Obtener pagos pr√≥ximos a vencer', async () => {
            const response = await this.makeRequest('GET', '/pagos/proximos-vencer?dias=7');
            if (!response.data.success) throw new Error('Error al obtener pagos pr√≥ximos a vencer');
            console.log(`   ‚ö†Ô∏è  Pagos que vencen en 7 d√≠as: ${response.data.data.pagos.length}`);

            if (response.data.data.pagos.length > 0) {
                response.data.data.pagos.forEach(pago => {
                    console.log(`      - ${pago.nombre_miembro}: $${pago.monto.toLocaleString()} (vence: ${pago.fecha_vencimiento})`);
                });
            }
        });

        // Test 8: Historial de pagos de un miembro
        await this.test('Obtener historial de pagos de miembro', async () => {
            const response = await this.makeRequest('GET', '/pagos/miembro/1');
            if (!response.data.success) throw new Error('Error al obtener historial');
            console.log(`   üìù Historial del miembro 1: ${response.data.data.historial.length} pagos`);
        });

        // Test 9: Actualizar estado de pago
        await this.test('Actualizar estado de pago', async () => {
            if (!nuevoPagoId) throw new Error('No hay ID de pago para actualizar (Test 2 fall√≥)');
            const response = await this.makeRequest('PUT', `/pagos/${nuevoPagoId}/estado`, {
                estado: 'pendiente',
                notas: 'Pago marcado como pendiente para prueba'
            });
            if (!response.data.success) throw new Error('No se pudo actualizar el estado');
            console.log(`   üîÑ Estado actualizado a: ${response.data.data.estado}`);
        });

        // Test 10: Renovar membres√≠a
        await this.test('Renovar membres√≠a de miembro', async () => {
            const response = await this.makeRequest('POST', '/pagos/renovar-membresia', {
                miembro_id: 2,
                tipo_membresia_id: 2
            });
            if (!response.data.success) throw new Error('No se pudo renovar la membres√≠a');
            console.log(`   üîÑ Membres√≠a renovada para miembro 2`);
            console.log(`   üí∞ Nuevo pago: $${response.data.data.monto.toLocaleString()}`);
            console.log(`   üìÖ Vence: ${response.data.data.fecha_vencimiento}`);
        });

        // Test 11: Marcar pagos vencidos
        await this.test('Marcar pagos vencidos autom√°ticamente', async () => {
            const response = await this.makeRequest('POST', '/pagos/marcar-vencidos');
            if (!response.data.success) throw new Error('Error al marcar pagos vencidos');
            console.log(`   ‚è∞ ${response.data.data.pagos_marcados} pagos marcados como vencidos`);
        });

        // Test 12: Filtros avanzados con paginaci√≥n
        await this.test('Filtros avanzados con paginaci√≥n', async () => {
            const response = await this.makeRequest('GET', '/pagos?limite=5&offset=0&metodo_pago=efectivo');
            if (!response.data.success) throw new Error('Error en filtros avanzados');
            console.log(`   üìÑ P√°gina 1: ${response.data.data.pagos.length} pagos (m√©todo: efectivo)`);
            console.log(`   üìä Total: ${response.data.data.total} registros`);
        });

        // Test 13: Estad√≠sticas por rango de fechas
        await this.test('Estad√≠sticas por rango de fechas', async () => {
            const fechaDesde = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const fechaHasta = new Date().toISOString().split('T')[0];

            const response = await this.makeRequest('GET', `/pagos/estadisticas?fecha_desde=${fechaDesde}&fecha_hasta=${fechaHasta}`);
            if (!response.data.success) throw new Error('Error en estad√≠sticas por fechas');

            const stats = response.data.data;
            console.log(`   üìÖ Per√≠odo: ${fechaDesde} a ${fechaHasta}`);
            console.log(`   üí∞ Ingresos del per√≠odo: $${stats.resumen.ingresos_confirmados.toLocaleString()}`);
        });

        // Resumen final
        console.log('\nüìä RESUMEN DE PRUEBAS');
        console.log('====================');
        console.log(`‚úÖ Pruebas exitosas: ${this.testResults.passed}`);
        console.log(`‚ùå Pruebas fallidas: ${this.testResults.failed}`);
        console.log(`üìä Total ejecutadas: ${this.testResults.total}`);
        console.log(`üìà Tasa de √©xito: ${((this.testResults.passed / this.testResults.total) * 100).toFixed(1)}%`);

        if (this.testResults.failed === 0) {
            console.log('\nüéâ ¬°TODAS LAS PRUEBAS PASARON EXITOSAMENTE!');
            console.log('üí≥ Sistema de pagos y membres√≠as funcionando correctamente');
        } else {
            console.log('\n‚ö†Ô∏è  Algunas pruebas fallaron. Revisar implementaci√≥n.');
        }
    }
}

// Ejecutar las pruebas
const testSuite = new PagosTestSuite();
testSuite.runTests().catch(console.error);
